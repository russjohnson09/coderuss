<!doctype html>

<!-- ASSIGN OUR ANGULAR MODULE -->
<html>

<head>
    <!-- META -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Optimize mobile viewport -->

    <title>Coderuss</title>

    <link rel="stylesheet" href="/css/ext/bootstrap.min.css">
    <style>
    </style>


    <script src="https://use.fontawesome.com/7c2b0d3adf.js"></script>


    <!--<script src="/js/ext/jquery-3.2.1.min.js"></script>-->
    <script src="/bower_components/jquery/dist/jquery.js"></script>

    <script src="/bower_components/angular/angular.min.js"></script>
    <script src="/bower_components/angular-cookies/angular-cookies.min.js"></script>

    <script src="/js/ext/bootstrap-3.3.7.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-route.js"></script>

    <script src="/bower_components/moment/moment.js"></script>
    <script src="/bower_components/moment-timezone/builds/moment-timezone-with-data.js"></script>

    <script src="/bower_components/angular-hotkeys/build/hotkeys.js"></script>
    <link rel="stylesheet" href="/bower_components/angular-hotkeys/build/hotkeys.css">

</head>

<body>
<div class="container">

    <div ng-app="app" class="login">

        <div class="row">
            <div class="col-sm-1"><a href="#!habits">Habits</a></div>
            <div class="col-sm-1"><a href="#!login">Login</a></div>
            <!--<div class="col-md-3">-->
                <!--<ul class="nav">-->
                    <!--<li><a href="#!hello"> Add New Order </a></li>-->
                    <!--<li><a href="#!test"> Show Order </a></li>-->
                    <!--<li><a href="#!movie"> Movie Search </a></li>-->
                    <!--<li><a href="#!gitreview/4c20768f288af579519e887674ddcea5300a7d1d"> Git Review </a></li>-->
                <!--</ul>-->
            <!--</div>-->
        </div>

        <div class="row">
            <div class="col-sm-12">
                <div ng-view></div>
            </div>
        </div>

        <div ng-show="devMode" class="user">
            {{user}}
        </div>


    </div>
</div>


<script>
    //    angular.module('movieDirective', [])
    //        .controller('Controller', ['$scope', function($scope) {
    //            $scope.customer = {
    //                name: 'Naomi',
    //                address: '1600 Amphitheatre'
    //            };
    //        }])
    //        .directive('myCustomer', function() {
    //            return {
    //                restrict: 'E',
    //                templateUrl: 'my-customer.html'
    //            };
    //        });
</script>

<script>

    var app = angular.module('app', ['ngRoute', 'ngCookies','cfp.hotkeys']);
    //
    //    app.config(['$locationProvider', function ($locationProvider) {
    //        $locationProvider.html5Mode({
    //            enabled: true,
    //            requireBase: false
    //        });
    //    }]);
    //
    app.config(function ($routeProvider) {
        console.log('routeProviderConfig', $routeProvider);
        $routeProvider
            .when("/login", {
                templateUrl: "templates/login.html",
                controller: "loginCtl"
            })
            .when("/habits", {
                templateUrl: "templates/habits.html",
                controller: "habitsCtl"
            })
            .when('/movie', {
                templateUrl: 'templates/movie.html',
                controller: "movieCtl"
            })
            .when('/gitreview/:sha', {
                templateUrl: 'templates/gitreview.html',
                controller: "gitreviewCtl"
            })
            .when("/tests", {
                templateUrl: "templates/tests.html",
                controller: "testsCtl"
            })
            .when("/profile", {
                templateUrl: "templates/profile.html",
                controller: "profileCtl"
            })
            .when('/shewaspretty', {
                templateUrl: 'templates/shewaspretty.html',
                controller: "shewasprettyCtl"
            })
            .otherwise({
                redirectTo: '/profile'
            });
    });

    app.factory('User', ['$http', '$q', function ($http, $q) {
        function User(data) {
            if (data) {
                this.setData(data);
            }
        };

        var baseurl = '';

        User.prototype = {
            setData: function (data) {
                angular.extend(this,{dates: {}}, data);
            },
            getCurrentUser: function () {
                var self = this;
                return $q(function(resolve) {
                    var url = baseurl + '/v1/users/me';
                    $http(
                        {
                            method: 'GET',
                            url: url,
                            headers: {},
                        }
                    ).then(function (response) {
                        var user = new User(response.data);
                        resolve(user);
                    });
                });

            }
        };

        return User;
    }]);


    (function addProfileCtl() {
        app.controller('profileCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams','hotkeys',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys) {

            }])
    })();


    (function addLoginCtl() {
        app.controller('loginCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'Habit','hotkeys',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, Habit, hotkeys) {
                $scope.login = function()
                {
                    $http.post('/v1/login', $scope.formData).then(
                        function (res) {
                            if (res.status === 201) {
                                $location.path('/');
                            }
                        },
                        function (res) {
                            console.log(res.status);
                        });
                };

            }])
    })();

    (function addHabitsCtl() {
        app.factory('Habit', ['$http', '$q', function ($http, $q) {
            function Habit(data) {
                if (data) {
                    this.setData(data);
                }
            };

            var baseurl = '';

            Habit.prototype = {
                setData: function (data) {
                    angular.extend(this,{dates: {}}, data);
                },
                getJSON: function () {
                    return JSON.stringify(this.getJSONObject());
                },
                getJSONObject: function () {
                    return {
                        text: this.text,
                    }
                },
                getHabits: function () {
                    console.log('get habits')
                    var self = this;
                    var url = baseurl + '/v1/habits';
                    return $q(function (resolve, reject) {
                        $http(
                            {
                                method: 'GET',
                                url: url,
                                headers: {
                                    'cache-control': 'no-cache'
                                },
                            }
                        ).then(function (response) {
                            var habits = [];
                            if (response.data) {
                                for (var i in response.data) {
                                    habits.push(new Habit(response.data[i]));
                                }
                                resolve(habits);
                            }
                        });
                    })
                },
                add: function () {
                    var self = this;
                    return $q(function(resolve) {
                        var url = baseurl + '/v1/habits';
                        $http(
                            {
                                method: 'POST',
                                url: url,
                                data: self.getJSON(),
                                headers: {
                                    'content-type': 'application/json',
                                    'cache-control': 'no-cache'
                                },
                            }
                        ).then(function (response) {
                            if (response.data && response.data) {
                                self.setData(response.data);
                                resolve(self);
                            }
                        });
                    });

                },
                getStatus: function () {
                    return this._status;
                },
                updateDate: function(date)
                {
                    var self = this;
                    var status;
                    if (self.getDate(date).status !== 'complete') {
                        status = 'complete';
                    }
                    else {
                        status = 'incomplete';
                    }
                    var url = baseurl + '/v1/habits/' + self._id + '/dates/' + date;
                    $http(
                        {
                            method: 'POST',
                            url: url,
                            headers: {},
                            data: {
                                status: status
                            }
                        }
                    ).then(function (response) {
                        self.dates[date] = response.data;
                    });
                },
                populateDate: function (date) {
                    var self = this;
                    var url = baseurl + '/v1/habits/' + self._id + '/dates/'
                        + date;
                    $http(
                        {
                            method: 'GET',
                            url: url,
                            headers: {},
                        }
                    ).then(function (response) {
                        self.dates[date] = response.data;
                    });
                },
                getDate: function (date) {
                    var self = this;

                    if (self.dates[date] === undefined) {
                        self.dates[date] = 'loading';
                        self.populateDate(date);
                    }

                    return self.dates[date];
                },
                delete: function () {
                    var self = this;
                    this._status = 'deleted';
                    var url = baseurl + '/v1/habits/' + self._id;
                    $http(
                        {
                            method: 'DELETE',
                            url: url,
                            headers: {
                                'content-type': 'application/json',
                                'cache-control': 'no-cache'
                            },
                        }
                    ).then(function (response) {
                    });
                }
            };

            return Habit;
        }]);

        app.controller('habitsCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'Habit','hotkeys','User',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, Habit,
            hotkeys,
            User) {

                var HabitService = new Habit();
                var UserService = new User();

                UserService.getCurrentUser().then(function(user) {
                    $rootScope.user = user;
                });

                $scope.habits = [
//                    new Habit({
//                        'id': 1,
//                        'description': 'exercise',
//                    })
                ];
                $scope.devMode = false;

                hotkeys.bindTo($scope)
                    .add({
                        combo: 'd e v',
                        description: 'Dev mode',
                        callback: function() {
                            $scope.devMode = true;
                        }
                    })
                    // you can chain these methods for ease of use:
//                    .add ({...});


                //https://momentjs.com/docs/#/displaying/
                $scope.weekdays = [];
                var startOfWeek = moment().startOf('week');
                for(var i = 0;i < 7; i++) {
                    $scope.weekdays.push(moment(startOfWeek).add(i,'days'));
                }

                HabitService.getHabits().then(function (habits) {
                    $scope.habits = habits;
                });


                $scope.newhabit = new Habit({});

                $scope.addHabit = function () {
                    $scope.newhabit.add().then(function(habit) {
                        $scope.habits.push(habit);
                    });
                    $scope.newhabit = new Habit({});
                };

                console.log($scope.habits);


            }]);


    })();


    app.directive("preview", function () {
        function link(scope, element) {
            var iframe = document.createElement('iframe');
            var element0 = element[0];
            element0.appendChild(iframe);
            var body = iframe.contentDocument.body;

            scope.$watch('content', function () {
                body.innerHTML = scope.content;
            });
        }

        return {
            link: link,
            restrict: 'E',
            scope: {
                content: '='
            }
        };
    });


    //http://www.webdeveasy.com/angularjs-data-model/
    //https://api.github.com/repos/russjohnson09/coderuss/commits/4c20768f288af579519e887674ddcea5300a7d1d
    app.factory('Gitcommit', ['$http', function ($http) {
        function Gitcommit(data) {
            if (data) {
                this.setData(data);
            }
        };

        const GITHUB_API = '/v1/proxy/github';

        var context = '';
        Gitcommit.prototype = {
            setContext: function (val) {
                context = val;
            },
            getContext: function () {
                return context;
            },
            setData: function (data) {
                angular.extend(this, data);
            },
            getStats: function () {
                console.log('getStats', this, this.stats);
                if (typeof this.stats == 'undefined') {
                    this.stats = {};
                    this.populateCommit();
                }

                return this.stats;
            },
            updateCommitStatusPending: function () {
                var self = this;
                var url = GITHUB_API
                    + '/repos/russjohnson09/coderuss/statuses/' + self.sha;

                var data = {
                    "state": "pending",
                    "target_url": window.location.origin + self.sha,
                    "description": "pending",
                    "context": self.getContext()
                };

                console.log('updateCommitStatusPending', data);

                $http(
                    {
                        method: 'POST',
                        url: url,
                        data: JSON.stringify(data),
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {
                    console.log('updateCommitStatusPending', response);
                    if (response.data && response.data) {
                        self.setData(response.data);
                    }
                });
            },
            updateCommitStatusSuccess: function () {
                var self = this;
                var url = GITHUB_API
                    + '/repos/russjohnson09/coderuss/statuses/' + self.sha;

                var data = {
                    "state": "success",
                    "target_url": window.location.origin + self.sha,
                    "description": "success description",
                    "context": self.getContext()
                };

                console.log('updateCommitStatusPending', data);

                $http(
                    {
                        method: 'POST',
                        url: url,
                        data: JSON.stringify(data),
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {
                    console.log('updateCommitStatusPending', response);
                    if (response.data && response.data) {
                        self.setData(response.data);
                    }
                });
            },
            populateCommit: function () {
                var self = this;
                console.log('populateCommit');
                var url = GITHUB_API
                    + '/repos/russjohnson09/coderuss/commits/' + self.sha;
                //X-GitHub-Request-Id
                //xsrfHeaderName
                console.log('populateCommit', url);

                $http(
                    {
                        method: 'GET',
                        url: url,
//                        xsrfHeaderName: 'X-GitHub-Request-Id ',
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
//                        params: {
////                            _proxy: 1,
////                            query: $scope.movie.query
//                        }
                    }
                ).then(function (response) {
                    console.log('populateCommit', response);
                    if (response.data && response.data) {
                        self.setData(response.data);
                    }
                });
//                /repos/russjohnson09/coderuss/commits/{{sha}}
//                $http.get()
//                    .then(function(data) {
//                        console.log(data);
//                });
            },
            loadCommitData: function (sha) {
                var scope = this;
                $http.get('ourserver/books/' + bookId).success(function (bookData) {
                    scope.setData(bookData);
                });
            },
            load: function (id) {
                var scope = this;
                $http.get('ourserver/books/' + bookId).success(function (bookData) {
                    scope.setData(bookData);
                });
            },
            delete: function () {
                $http.delete('ourserver/books/' + bookId);
            },
            update: function () {
                $http.put('ourserver/books/' + bookId, this);
            },
            getImageUrl: function (width, height) {
                return 'our/image/service/' + this.book.id + '/' + width + '/' + height;
            },
            isAvailable: function () {
                if (!this.book.stores || this.book.stores.length === 0) {
                    return false;
                }
                return this.book.stores.some(function (store) {
                    return store.quantity > 0;
                });
            }
        };

        return Gitcommit;
    }]);

    app.controller('gitreviewCtl', ['$rootScope', '$cookies', '$scope', '$location',
        '$http', '$routeParams', 'Gitcommit',
        function ($rootScope, $cookies, $scope, $location, $http, $routeParams, Gitcommit) {

            console.log('gitreviewCtl');

            console.log('cookies', $cookies.getAll());

            //        $scope.sha = $routeParams.sha;

            var gitcommit = $scope.gitcommit = new Gitcommit({sha: $routeParams.sha});

            var url = '/v1/ping';
            $http(
                {
                    method: 'GET',
                    url: url,
                    headers: {
                        'content-type': 'application/json',
                        'cache-control': 'no-cache'
                    },
                }
            ).then(function (response) {
                console.log(url, response);
                gitcommit.setContext(response.data.server.context);
            });
        }]);

    app.controller('shewasprettyCtl', ['$rootScope', '$cookies', '$scope', '$location',
        '$http', '$routeParams',
        function ($rootScope, $cookies, $scope, $location, $http, $routeParams) {

//            var url = '/v1/ping';
//            $http(
//                {
//                    method: 'GET',
//                    url: url,
//                    headers: {
//                        'content-type': 'application/json',
//                        'cache-control': 'no-cache'
//                    },
//                }
//            ).then(function (response) {
//                console.log(url, response);
//            });

            url = 'http://myasiantv.online/video/drama/she-was-pretty/episode-3/';

            url = '/v1/shewaspretty';
            $http(
                {
                    method: 'GET',
                    url: url,
                    headers: {
                        'content-type': 'application/json',
                        'cache-control': 'no-cache'
                    },
                }
            ).then(function (response) {
                console.log(url, response);
                $scope.episodes = response.data;
            }, function (err) {
                console.error(err);
            });
        }]);

    app.controller('movieCtl', function ($rootScope, $scope, $location, $http, $routeParams) {

        $scope.ID = $routeParams.ID;

        $scope.formData = {};

        $scope.alerts = [];

        $scope.movie = {};

        $scope.movieSearch = {};

        //https://image.tmdb.org/t/p/w500/n1y094tVDFATSzkTnFxoGZ1qNsG.jpg
        $scope.searchMovie = function (movie) {
            console.log('searchMovie');
            $http(
                {
                    method: 'get',
                    url: '/proxy/themoviedb/search/movie',
                    headers: {
                        'content-type': 'application/json',
                        'cache-control': 'no-cache'
                    },
                    params: {
                        _proxy: 1,
                        query: $scope.movie.query
                    }
//                    qs: {
//                        query: $scope.movie.query
//                    }
                }
            ).then(function (response) {
                if (response.data && response.data.results &&
                    response.data.results[0]) {
                    Object.assign($scope.movie, response.data.results[0])
                    //https://image.tmdb.org/t/p/w500/n1y094tVDFATSzkTnFxoGZ1qNsG.jpg
                    if ($scope.movie.backdrop_path) {
                        $scope.movie.imagePath = 'https://image.tmdb.org/t/p/w500' + $scope.movie.backdrop_path
                    }
                }
                console.log(response);
            }, function (err) {
                console.log(err);
            })
        };

        var params = $location.search();

    })
        .directive('movie', function () {
            return {
                restrict: 'E',
                scope: {
                    movie: '=movie',
                    searchMovie: '=searchMovie'

                },
                templateUrl: 'directives/movie.html'
            };
        });


    app.controller('testsCtl', ['$rootScope', '$cookies', '$scope', '$location',
        '$http', '$routeParams', '$sce',
        function ($rootScope, $cookies, $scope, $location, $http, $routeParams, $sce) {

            var APP_BASE_URL = '';

            $scope.testMain = function () {
                var url = APP_BASE_URL + '/v1/selftest/main/run';
                $http(
                    {
                        method: 'POST',
                        url: url,
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {

                    var result = [];
                    console.log(response.data);
                    response.data.tests.forEach(function (test) {
                        result.push(test);
                        test.response.rawResponseHtml = $sce.trustAsHtml(test.response.rawResponseBody);

                    });

                    $scope.tests = result;

                }, function (err) {
                    console.error(err);
                });
            };

            $scope.testFail = function () {
                var url = APP_BASE_URL + '/v1/selftest/main/runfail';
                $http(
                    {
                        method: 'POST',
                        url: url,
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {

                    var result = [];
                    console.log(response.data);
                    response.data.tests.forEach(function (test) {
                        result.push(test);
                        test.response.rawResponseHtml = $sce.trustAsHtml(test.response.rawResponseBody);

                    });

                    $scope.tests = result;

                }, function (err) {
                    console.error(err);
                });
            };
        }]);


</script>
</body>

</html>

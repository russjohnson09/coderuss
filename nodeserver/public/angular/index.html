<!doctype html>

<!-- ASSIGN OUR ANGULAR MODULE -->
<html>

<head>

    <base href="/angular/">
    <!-- META -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Optimize mobile viewport -->

    <title>Coderuss</title>

    <link rel="stylesheet" href="/css/ext/bootstrap.min.css">

    <style>
        .tvshow-image {
            max-width: 100%;
            max-height: 400px;
        }
        .json {
            display: block;
            padding: 9.5px;
            margin: 0 0 10px;
            font-size: 13px;
            line-height: 1.42857143;
            color: #333;
            word-break: break-all;
            word-wrap: break-word;
            background-color: #f5f5f5;
            /*border: 1px solid #ccc;*/
            border-radius: 4px;
        }

        .row .iframe-thumbnail {
            max-height: 200px;
        }

        .iframe-thumbnail iframe {
            width: 1440px;
            height: 900px;
        }

        .iframe-thumbnail {
            position: relative;
            -ms-zoom: 0.25;
            -moz-transform: scale(0.25);
            -moz-transform-origin: 0 0;
            -o-transform: scale(0.25);
            -o-transform-origin: 0 0;
            -webkit-transform: scale(0.25);
            -webkit-transform-origin: 0 0;
        }

        i.danger {
            color: #d9534f
        }

        i.cr-panel-icon {
            font-size:20px;
            /*float:right;*/
        }

        .cr-panel-icon {
            font-size:20px;
            float:right;
        }


    </style>


    <script src="https://use.fontawesome.com/7c2b0d3adf.js"></script>


    <!--<script src="/js/ext/jquery-3.2.1.min.js"></script>-->
    <script src="/bower_components/jquery/dist/jquery.js"></script>

    <script src="/bower_components/angular/angular.min.js"></script>
    <script src="/bower_components/angular-cookies/angular-cookies.min.js"></script>

    <script src="/js/ext/bootstrap-3.3.7.min.js"></script>
    <script src="/js/ext/sinon-2.3.8.js"></script>


    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-route.js"></script>

    <script src="/bower_components/moment/moment.js"></script>
    <script src="/bower_components/moment-timezone/builds/moment-timezone-with-data.js"></script>

    <script src="/bower_components/angular-hotkeys/build/hotkeys.js"></script>
    <link rel="stylesheet" href="/bower_components/angular-hotkeys/build/hotkeys.css">

    <script src="/bower_components/angular-sanitize/angular-sanitize.js"></script>

    <link href="/bower_components/noty/lib/noty.css" rel="stylesheet">
    <script src="/bower_components/noty/lib/noty.js"></script>


    <link href="/bower_components/json-formatter/dist/json-formatter.css" rel="stylesheet">
    <script src="/bower_components/json-formatter/dist/json-formatter.js"></script>


</head>

<body ng-app="app" ng-cloak>

<nav ng-controller="navbarCtl" class="navbar navbar-default">
    <div class="container-fluid" ng-cloak>
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <!--<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">-->
            <!--<span class="sr-only">Toggle navigation</span>-->
            <!--<span class="icon-bar"></span>-->
            <!--<span class="icon-bar"></span>-->
            <!--<span class="icon-bar"></span>-->
            <!--</button>-->
            <a class="navbar-brand" href="/angular">coderuss</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <ul class="nav navbar-nav">
            <!--<li ng-class="{active: isActive('/habits')}"><a href="#!/habits">habits</a></li>-->
        </ul>

        <div ng-show="getCurrentUser().isLoaded()">
            <ul class="nav navbar-nav navbar-right " ng-show="(getCurrentUser().isLoggedIn())">
                <li class="dropdown">
                    <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button"
                       aria-haspopup="true" aria-expanded="false">{{getCurrentUser().username}} <span
                            class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="#!/profile">Profile</a></li>
                        <li><a href="#!/habits">Habits</a></li>
                        <li><a href="#!/fitbit">Fitbit</a></li>
                        <li ng-show="true"><a href="#!/tvshows/showstatus">TV</a></li>
                        <li ng-show="getCurrentUser().isAdmin()"><a href="#!/postcards">Postcards</a></li>
                        <!--<li ng-show="getCurrentUser().isAdmin()"><a href="#!/tvshows">TV</a></li>-->
                        <li ng-show="getCurrentUser().isAdmin()"><a href="#!/users">Users</a></li>
                        <li ng-show="getCurrentUser().isAdmin()"><a href="#!/shewaspretty">She was pretty</a></li>
                        <li ng-show="getCurrentUser().isAdmin()"><a href="#!/hello">Hello</a></li>
                        <li ng-show="getCurrentUser().isAdmin()">
                            <a href="#!/gitreview/4c20768f288af579519e887674ddcea5300a7d1d">
                                Git Review
                            </a></li>
                        <li><a href="#!/logout">Logout</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right " ng-show="!(getCurrentUser().isLoggedIn())">
                <li ng-class="{active: isActive('/signin')}"><a href="#!/signin">sign in</a></li>
                <li ng-class="{active: isActive('/signup')}"><a href="#!/signup">sign up</a></li>
            </ul>
        </div>

    </div><!-- /.container-fluid -->
</nav>


<div class="container">
    <div class="row">
        <div class="col-sm-12">
            <div ng-view></div>
        </div>
    </div>

    <div ng-show="devMode" class="user">
        {{user}}
    </div>

</div>

<script>

    var app = angular.module('app',
        ['ngRoute', 'ngCookies', 'cfp.hotkeys', 'ngSanitize', 'jsonFormatter']);

    app.config(function ($routeProvider, $locationProvider) {
        console.log('routeProviderConfig', $routeProvider);
        var userResolve = {
            _user: function (User) {
                console.log('resolve profile');
                var UserService = new User();
                console.log(UserService);
                return new Promise(function (resolve) {
                    UserService.getCurrentUser().then(function (user) {
                        console.log(user);
                        resolve(user);
                    });
                })
            }
        };
        $routeProvider
            .when("/login", {
                templateUrl: "templates/login.html",
                controller: "loginCtl"
            })
            .when("/login", {
                templateUrl: "templates/login.html",
                controller: "loginCtl"
            })
            .when("/signin", {
                templateUrl: "templates/login.html",
                controller: "loginCtl"
            })
            .when("/users", {
                templateUrl: "routes/users/users.html",
                controller: 'usersCtl'
            })
            .when("/signup", {
                templateUrl: "templates/signup.html",
                controller: "signupCtl"
            })
            .when("/logout", {
                controller: "logoutCtl",
                templateUrl: "templates/logout.html"
            })
            .when('/anchors', {
                templateUrl: 'templates/anchors.html'
            })
            .when("/fitbit", {
                templateUrl: "routes/fitbit/fitbit.html",
                controller: "fitbitCtl",
                resolve: userResolve,
            })
            .when("/fitbit/dev", {
                templateUrl: "routes/fitbit/fitbitdev.html",
                controller: "fitbitDevCtl",
                resolve: userResolve,
            })
            .when("/habits", {
                templateUrl: "templates/habits.html",
                controller: "habitsCtl",
                resolve: userResolve,
            })
            .when("/habits/:id", {
                templateUrl: "routes/habits/habit.html",
                controller: "habitsIdCtl",
                resolve: userResolve,
            })
            .when("/postcards", {
                templateUrl: "templates/postcards/postcards.html",
                controller: "postcardsCtl",
                resolve: userResolve,
            })
            .when('/movie', {
                templateUrl: 'templates/movie.html',
                controller: "movieCtl"
            })
            .when('/gitreview/:sha', {
                templateUrl: 'templates/gitreview.html',
                controller: "gitreviewCtl"
            })
            .when('/apitests/testsuites', {
                templateUrl: "routes/apitests/testsuites.html",
                controller: 'apitestsTestSuitesCtl'
            })
            .when('/apitests/testsuites/:id', {
                templateUrl: "routes/apitests/testsuites-view.html",
                controller: 'apitestsTestSuitesViewCtl'
            })
            .when('/apitests/testsuites/:id/runs', {
                templateUrl: "routes/apitests/testsuites-runs.html",
                controller: 'apitestsTestSuitesRunsCtl'
            })
            .when("/tests", {
                templateUrl: "templates/tests.html",
                controller: "testsCtl"
            })
            .when("/tvshows", {
                templateUrl: "templates/tvshows/tvshows.html",
                controller: "tvshowsCtl",
                resolve: userResolve,
            })
            .when("/tvshows/details/:id", {
                templateUrl: "templates/tvshows/tvshows_id.html",
                controller: "tvshowsIdCtl",
                resolve: userResolve,
            })
            .when("/tvshows/search", {
                templateUrl: "templates/tvshows/search-tvshows.html",
                controller: "searchTvshowsCtl",
                resolve: userResolve,
            })
            .when("/tvshows/showstatus", {
                templateUrl: "templates/tvshows/showstatus.html",
                controller: "tvshowsShowstatusCtl",
                resolve: userResolve,
            })
            .when("/profile", {
                templateUrl: "templates/profile/profile.html",
                controller: "profileCtl",
                resolve: userResolve,
            })
            .when('/shewaspretty', {
                templateUrl: 'templates/shewaspretty.html',
                controller: "shewasprettyCtl"
            })
            .when('/hello', {
                templateUrl: 'templates/hello.html',
                controller: "helloCtl"
            })
            .otherwise({
                redirectTo: '/profile'
            });
    });

    app.run(function ($rootScope, LoggedInService) {
        $rootScope.$on("$routeChangeStart", function (event, next, current) {
            console.log(event, next, current);
        });
        $rootScope.$on("$routeChangeSuccess", function (event, next, current) {
            console.log(event, next, current);
        });
    });

    app.factory('ErrorService', ['$http', '$q', function ($http, $q) {

        var service = {};

        service.handleHttpError = function (res) {
            console.log('handleHttpError', res);
            var message = res.status + ': ';
            if (res.data) {
                if (res.data.message) {
                    message += res.data.message;
                }
                else if (res.data.error) {
                    if (res.data.error.message) {
                        message += res.data.error.message;
                    }
                }
                else if (res.data.meta && res.data.meta.message) {
                    message += res.data.meta.message;
                }
                else {
                    message += JSON.stringify(res.data);
                }
            }
            new Noty({
                text: message,
                animation: {},
                type: 'error'
            }).show();
        };

        return service;
    }]);

    (function addTvshowRoute() {

        app.directive('tvshowDisplay', function () {
            return {
                restrict: 'E',
                scope: {
                    tvshow: '=tvshow',

                },
                templateUrl: 'templates/tvshows/_tvshow-display.html'
            };
        });

        app.directive('apiTvshowDisplay', function () {
            return {
                restrict: 'E',
                scope: {
                    apiTvshow: '=apiTvshow',
                    devMode: '=devMode'

                },
                templateUrl: 'templates/tvshows/_api-tvshow-display.html'
            };
        });

        app.directive('tvshowTds', function () {
            return {
                restrict: 'A',
                scope: {
                    tvshow: '=tvshow',
                    devMode: '=devMode'
                },
                templateUrl: 'templates/tvshows/_tvshow-tds.html'
            };
        });

        app.directive('tvshowListItem', function () {
            return {
                restrict: 'E',
                scope: {
                    tvshow: '=tvshow',
                    devMode: '=devMode',
                    remove: '=remove'
                },
                templateUrl: 'templates/tvshows/_tvshow-list-item.html'
            };
        });

        app.directive('tvshowSearchItem', function () {
            return {
                restrict: 'E',
                scope: {
                    tvshow: '=tvshow',
                },
                templateUrl: 'templates/tvshows/_tvshow-search-item.html'
            };
        });

        app.factory('TvshowService', ['$http', '$q', '$timeout', 'ErrorService',
            function ($http, $q, $timeout, ErrorService) {

                var service = {};

                var baseurl = '/v1/proxy/tvmaze';
                var apibaseurl = '';

                function Tvshow(data) {
                    if (data) {
                        this.setData(data);
                    }
                };

                Tvshow.prototype = {
                    setData: function (data) {
                        angular.extend(this, data);
                    },
                    addToUserList: function () {
                        var self = this;
                        self._status = 'updating';
                        var data = self.getCreateObject();

                        $http({
                            method: 'POST',
                            data: data,
                            url: apibaseurl + '/v3/users/me/tvshows'
                        }).then(function (res) {
                            self._status = '';
                            new Noty({
                                text: 'Added "' + self.name + '"',
                                type: 'success',
                                timeout: 1000
                            }).show();
                        }, ErrorService.handleHttpError);
                    },
                    getCreateObject: function () {
                        var self = this;
                        return {
                            tvmaze_id: self.id
                        };
                    },
                    getEpisodeIdFromHref: function(href)
                    {
                        return href.split('/').pop();
                    },
                    getNextEpisode: function() {
                        var self = this;
                        if (!self._nextEpisode) {
                            self._nextEpisode = new Episode({
                                _status: 'loading'
                            });
                            if (!self._links || ! self._links.nextepisode) {
                                self._nextEpisode._status = 'null';
                            }
                            else {
                                var id = self.getEpisodeIdFromHref(self._links.nextepisode.href);
                                var url = baseurl + '/episodes/' + id;

                                $http({
                                    method: 'GET',
                                    url: url
                                }).then(function (res) {
//                                    self._nextEpisode = {
//                                        _status: 'success'
//                                    };
                                    Object.assign(self._nextEpisode,{'_status': 'success'},
                                        res.data);

                                }, ErrorService.handleHttpError);
                            }

                        }
                        return self._nextEpisode;
                    },
                    getPreviousEpisode: function() {
                        var self = this;
                        if (!self._previousEpisode) {
                            self._previousEpisode = new Episode({
                                _status: 'loading'
                            });
                            if (!self._links || ! self._links.previousepisode) {
                                self._previousEpisode._status = 'null';
                            }
                            else {
                                var id = self.getEpisodeIdFromHref(self._links.previousepisode.href);
                                var url = baseurl + '/episodes/' + id;

                                $http({
                                    method: 'GET',
                                    url: url
                                }).then(function (res) {

                                    Object.assign(self._previousEpisode,{'_status': 'success'},
                                        res.data);

                                }, ErrorService.handleHttpError);
                            }

                        }
                        return self._previousEpisode;
                    },

                };


                function Episode(data) {
                    if (data) {
                        this.setData(data);
                    }
                };

                Episode.prototype = {
                    setData: function (data) {
                        angular.extend(this, data);
                    },
                    getAirstamp: function()
                    {
                        return moment(this.airstamp).tz(moment.tz.guess());
                    },
                    getHumanReadableAirStamp: function()
                    {
                        return moment(this.airstamp).tz(moment.tz.guess()).format('MMMM Do YYYY, h:mm:ss a z');
                    }
                };

                service.getTvShowById = function(id)
                {
                    var tvshow = new ApiTvshow({_status:'loading'});
                    var url = apibaseurl + '/v3/users/me/tvshows/' + id;
                    $http(
                        {
                            method: 'GET',
                            url: url
                        }).then(
                        function (res) {
                            tvshow.setData(res.data);
                            tvshow.setData({_status:'done'});
                        },
                        ErrorService.handleHttpError);

                    return tvshow;
                };

                service.getTvShowsBySearchString = function (searchstring) {
                    var result = {
                        status: 'loading',
                        data: null,
                    };

                    var url = baseurl + '/search/shows';
                    $http(
                        {
                            method: 'GET',
                            params: {
                                q: searchstring
                            },
                            url: url
                        }).then(
                        function (res) {
                            var tvshows = [];
                            for (var i in res.data) {
                                var tvshow = new Tvshow(res.data[i].show);
                                tvshows.push(tvshow);
                            }
                            $timeout(function () {
                                Object.assign(result, {status: 'success', data: tvshows});
                            }, 0)
                        },
                        ErrorService.handleHttpError);

                    return result;
                };

                function ApiTvshow(data) {
                    if (data) {
                        this.setData(data);
                    }
                };

                ApiTvshow.prototype = {
                    setData: function (data) {
                        angular.extend(this, data);
                    },
                    get: function(name) {
                        var self = this;
                        if (self._relations == undefined) {
                            this._relations = {};
                        }
                        if (self._relations[name] == undefined) {
                            self._relations[name] = {_status: 'loading', data: null};

                            if (name == 'show') {
                                var url = baseurl + '/shows/' + self.tvmaze_id;
                                $http(
                                    {
                                        method: 'GET',
                                        url: url
                                    }).then(
                                    function (res) {
                                        var tvshow = new Tvshow(res.data);
                                        console.log('get','show',res.data,tvshow);
                                        self._relations[name]._status = 'done';
                                        self._relations[name].data = tvshow;
                                    },
                                    ErrorService.handleHttpError);
                            }
                        }
                        return this._relations[name].data;
                    },
                    isLoading: function(name) {
                        if (this._relations == undefined) {
                            this._relations = {};
                        }
                        if (this._relations[name] == undefined) {
                            this.get(name);
                        }
                        return this._relations[name]['_status'] === 'loading';
                    },
                    removeFromMyList: function () {
                        var self = this;

                        self._status = 'deleted';

                        console.log('removeFromMyList', self, self._id);
                        $http({
                            method: 'DELETE',
                            url: apibaseurl + '/v3/users/me/tvshows/' + self._id
                        }).then(function (res) {
                            self._status = 'deleted';
                        }, ErrorService.handleHttpError);
                    },
                    getShow: function () {
                        var self = this;
                        if (!self._show) {
                            self._show = new Tvshow({_status: 'loading'});

                            var url = baseurl + '/shows/' + self.tvmaze_id;
                            $http(
                                {
                                    method: 'GET',
                                    url: url
                                }).then(
                                function (res) {
                                    var tvshow = new Tvshow(res.data);
                                    self._show = tvshow;
                                },
                                ErrorService.handleHttpError);

//                        $timeout(function() {
//                            Object.assign(self._show,{status:'success',data: 'test'});
//                        },2000);
                        }
                        ;

                        console.log('getShow', self);

                        return self._show;


                        console.log('result');

                        return self._show;
                    }

                };

                service.getMyTvShows = function () {
                    var result = {
                        status: 'loading',
                        data: [],
                    };

                    var url = apibaseurl + '/v3/users/me/tvshows';
                    $http(
                        {
                            method: 'GET',
                            url: url
                        }).then(
                        function (res) {

                            var apiTvshows = [];
                            for (var i in res.data) {
                                var apiTvshow = new ApiTvshow(res.data[i]);
                                apiTvshows.push(apiTvshow);
                            }
                            $timeout(function () {
                                Object.assign(result, {status: 'success', data: apiTvshows});
                            }, 0);
                        },
                        ErrorService.handleHttpError);

                    return result;
                };

                service.getTvshowById = function (id) {
                    var result = {
                        status: 'loading',
                        data: {},
                    };

//                return result;

                    var url = baseurl + '/shows/' + id;
                    $http(
                        {
                            method: 'GET',
                            url: url
                        }).then(
                        function (res) {
                            var tvshow = new Tvshow(res.data);
                            Object.assign(result, {status: 'success', data: tvshow});
                        },
                        ErrorService.handleHttpError);

                    return result;
                };

                return service;
            }]);


        app.controller('tvshowsShowstatusCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'hotkeys', 'UserService', 'TvshowService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,
                      UserService, TvshowService) {

                hotkeys.bindTo($scope)
                    .add({
                        combo: 'd e v',
                        description: 'Dev mode',
                        callback: function () {
                            $scope.devMode = !$scope.devMode;
                        }
                    });

                $scope.apiTvshowsCollection = TvshowService.getMyTvShows();


            }]);

        app.controller('searchTvshowsCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'hotkeys', 'UserService', 'TvshowService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,
                      UserService, TvshowService) {

                hotkeys.bindTo($scope)
                    .add({
                        combo: 'd e v',
                        description: 'Dev mode',
                        callback: function () {
                            $scope.devMode = !$scope.devMode;
                        }
                    });

                $scope.search = function () {
                    $scope.tvshows = TvshowService.getTvShowsBySearchString($scope.searchstring);
                }
            }]);

        app.controller('tvshowsIdCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'hotkeys', 'UserService', 'TvshowService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,
                      UserService, TvshowService) {

                $scope.tvshow = TvshowService.getTvShowById($routeParams.id)


            }]);


        app.controller('tvshowsCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'hotkeys', 'UserService', 'TvshowService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,
                      UserService, TvshowService) {

                hotkeys.bindTo($scope)
                    .add({
                        combo: 'd e v',
                        description: 'Dev mode',
                        callback: function () {
                            $scope.devMode = !$scope.devMode;
                        }
                    });

                $scope.apiTvshowsCollection = TvshowService.getMyTvShows();

            }])
    })();

    (function addLogoutCtl() {
        app.controller('logoutCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'hotkeys', 'UserService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys, UserService) {
                $scope.isActive = function (path) {
                    return path === $location.path();
                };

                UserService.logout().then(function (data) {
                    console.log(data);
                    $location.path('/signin');
                });
            }])
    })();

    (function addNavbarCtl() {

        app.controller('navbarCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'hotkeys', 'UserService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys, UserService) {
                $scope.isActive = function (path) {
                    return path === $location.path();
                };

                $scope.getCurrentUser = UserService.getCurrentUser;

//                UserService.getCurrentUser().then(function(user) {
//                    console.log('navbarCtl',user);
//                    $scope._user = user;
//                }, function(err) {
//                    console.log(e);
//                });
            }])
    })();

    (function addHelloCtl() {
        app.controller('helloCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'hotkeys','$interval',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,
            $interval) {
                $scope.hello = {};

                $scope.time = moment();

                $interval(function() {
                    updateCount++;
                    console.log(updateCount);
//                    if ((updateCount % (60*60)) == 0) {
//                        console.log('updated time');
//                    }
                    $scope.time = moment();
                },1000);

//                var clock = sinon.useFakeTimers(Date.now());
                var clock;

                var updateCount = 0;

                setInterval(function() {
                    console.log(1);
                },1000);


                $scope.freeze = function()
                {
                    if (clock) {
                        clock.restore();
                    }
                    clock = sinon.useFakeTimers(Date.now());

//                    setInterval(function() {
//                        console.log('freeze',1);
//                    },1000);
                };

                $scope.increaseTimeSeconds = function(seconds)
                {
                    if (!clock) {
                        clock = sinon.useFakeTimers(Date.now());
                    }
//                    clock.tick(seconds * 1000);
//                    return;
                    while(seconds > 0) {
                        if (seconds % (60*60) == 0) {
                            console.log('tick',seconds);
                        }
                        clock.tick(1000);
                        $scope.time = moment();
                        seconds--;
                    }
                };

                $scope.restore = function()
                {
                    if (clock) {
                        clock.restore();
                        clock = null;
                    }
                }

            }])
    })();

    app.factory('LoggedInService', ['$http', '$q', function ($http, $q) {

        var loggedInUser = null;

        var service = {
            setLoggedInUser: function (u) {
                loggedInUser = u;
                console.log(loggedInUser)
            },
            getLoggedInUser: function () {
                return loggedInUser;
            },
        };

        return service;

    }]);

    app.factory('UserService', ['$http', '$q', 'ErrorService', '$timeout',
        function ($http, $q,
                  ErrorService, $timeout) {

            var service = {};

        var baseurl = '';

        function User(data) {
            if (data) {
                this.setData(data);
            }
        };

        User.prototype.setData = function (data) {
            angular.extend(this, data);
        };

        User.prototype.isAdmin = function () {
            return this.is_admin === 1;
        };

        User.prototype.getLevel = function () {
            if (this._id == 'anon') {
                return 'anon';
            }
            else {
                return 'consumer';
            }
        };

        User.prototype.isLoaded = function () {
            return this._id;
        };

        User.prototype.isLoggedIn = function () {
            return this.getLevel() !== 'anon';
        };

        service.loginForm = function (formData) {
            return $q(function (resolve, reject) {
                $http.post('/v1/login', formData).then(
                    function (res) {
                        if (res.status === 201) {
                            return service.populateCurrentUser().then(resolve);
                        }
                    },
                    function (res) {
                        console.log(res.status);
                    });
            })

        };

        service.logout = function () {
            return $q(function (resolve, reject) {
                $http({
                    'method': 'POST',
                    'url': '/v1/logout'
                }).then(function (response) {
                        service.setCurrentUserToAnon();
                        resolve(response.data);
                    },
                    reject
                )
            });
        };

        service.setCurrentUserToAnon = function () {
            service._user = service.getAnonUser();
        };

        service.getAnonUser = function () {
            return new User({_id: 'anon'});
        };


        service.populateCurrentUser = function () {
            if (service._user == undefined) {
                service._user = new User({});
            }
            var url = baseurl + '/v1/users/me';

            return $q(function (resolve) {
                $http(
                    {
                        method: 'GET',
                        url: url,
                        headers: {},
                    }
                ).then(function (response) {
                    service._user = new User(response.data);
                    resolve(service._user);
                }, function () {
                    console.log('populateCurrentUser');
                    service.setCurrentUserToAnon();
                    resolve(service._user);
                });
            })
        };

        service.getCurrentUser = function () {
            if (service._user == undefined) {
                service.populateCurrentUser();
            }
            return service._user;

        };

        service.getUsers = function (params = []) {
            var result = {
                status: 'loading',
                data: null,
            };

            var url = baseurl + '/v1/users';
            $http(
                {
                    method: 'GET',
                    params: params,
                    url: url
                }).then(
                function (res) {
                    let objs = [];
                    for (let i in res.data) {
                        let obj = new User(res.data[i]);
                        objs.push(obj);
                    }
                    $timeout(function () {
                        Object.assign(result, {status: 'success', data: objs});
                    }, 200)
                },
                ErrorService.handleHttpError);

            return result;
        };

        return service;
    }]);

    app.factory('User', ['$http', '$q', function ($http, $q) {
        function User(data) {
            if (data) {
                this.setData(data);
            }
        };

        var baseurl = '';


        User.prototype = {

            setData: function (data) {
                angular.extend(this, {dates: {}}, data);
            },
            getCurrentUser: function () {
                var self = this;
                return $q(function (resolve) {
                    var url = baseurl + '/v1/users/me';
                    $http(
                        {
                            method: 'GET',
                            url: url,
                            headers: {},
                        }
                    ).then(function (response) {
                        var user = new User(response.data);
                        resolve(user);
                    });
                });

            }
        };

        return User;
    }]);


    (function addPostcards() {

        app.controller('postcardsCtl', ['_user', '$rootScope',
            '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'hotkeys','$timeout',
            'ErrorService',
            function (_user, $rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,
                      $timeout,
                      ErrorService) {
                $scope._user = _user;

                $scope.getTemplate = function(callback) {
                    $http.get($scope.selectedTemplate.front).then(function successCallback(res) {
                        $scope.postcard.front = res.data;
                        $http.get($scope.selectedTemplate.back).then(function successCallback(res) {
                            $scope.postcard.back = res.data;
                            callback();
                        });
                    });
                };

                $scope.postcardCheckout = {
                    status: 'incomplete'
                };

                $scope.populateTestData = function()
                {

                    $scope.postcard.to = {
                        name: 'Joe',
                        address_line1: 'Detroit',
                        address_city: 'Detroit',
                        address_state: 'MI',
                        address_zip: 48339,
                    };
                    $scope.postcard.from = {
                        name: 'Joe',
                        address_line1: 'Detroit',
                        address_city: 'Detroit',
                        address_state: 'MI',
                        address_zip: 48339,
                    };
                };

                $scope.preview = {};

                $scope.postcardPreview = function() {

                    $scope.getTemplate(function() {

                        $http.post('/v1/postcards/preview', $scope.postcard, {
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }).then(function successCallback(res) {
                                new Noty({
                                    text: JSON.stringify(res.data, null, '  '),
                                    animation: {}
                                }).show();
                                if (res.status === 200) {
                                    $timeout(function () {
                                        $scope.preview.front_src = res.data.thumbnails[0].large;
                                        $scope.preview.back_src = res.data.thumbnails[1].large;
                                        $scope.postcardCheckout.status = 'preview';
                                    }, 8000)
                                }
                            },
                            ErrorService.handleHttpError);
                    });
                };

                $scope.submitCompletePostcard = function() {
                    $scope.preview = {};

                    if ($scope.isSubmitted) {
                        return;
                    }
                    $scope.isSubmitted = true;

                    $http.post('/v1/postcards', $scope.postcard, {
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(function successCallback(res) {
                            new Noty({
                                text: JSON.stringify(res.data, null, '  '),
                                animation: {}
                            }).show();
                            if (res.status === 200) {
                                $timeout(function() {
                                    console.log($scope);
                                    $scope.preview.front_src = res.data.thumbnails[0].large;
                                    $scope.preview.back_src = res.data.thumbnails[1].large;
                                    console.log($scope.preview);
                                }, 8000)
                            }
                        },
                        ErrorService.handleHttpError);
                };


                hotkeys.bindTo($scope)
                    .add({
                        combo: 'd e v',
                        description: 'Dev mode',
                        callback: function () {
                            $scope.devMode = !$scope.devMode;
                        }
                    });


                $scope.templates = [{
                    value: {
                        type: 'birthday',
                        name: 'birthday',
                        front: '/angular/templates/postcards/postcardtemplates/_birthday_front.html',
                        back: '/angular/templates/postcards/postcardtemplates/_birthday_back.html'
                    },
//                    value: '/angular/templates/postcards/postcardtemplates/_birthday',
                    'label': 'Birthday'
                },
                    {
                        value: {
                            type: 'birthday',
                            name: 'birthday',
                            front: '/angular/templates/postcards/postcardtemplates/_birthday2_front.html',
                            back: '/angular/templates/postcards/postcardtemplates/_birthday2_back.html'
                        },
//                    value: '/angular/templates/postcards/postcardtemplates/_birthday',
                        'label': 'Birthday2'
                    },
//                    {
//                    value: 'postcard',
//                    'label': 'Postcard'
//                },
                ];

                $scope.postcard = {
//                    description: 'Demo Postcard job',
                    to: {
                        name: null,
                        address_line1: null,
                        address_city: null,
                        address_state: null,
                        address_zip: null,
                    },
                    from: {
                        name: null,
                        address_line1: null,
                        address_city: null,
                        address_state: null,
                        address_zip: null,
                    },
                    front: null,
                    back: null,
                    data: {
                        front_to_name: '',
                        back_body: '',
                        back_from_name: ''
                    },
//                    _front: '/angular/templates/postcards/postcardtemplates/_birthday_front.html',
//                    _back: '/angular/templates/postcards/postcardtemplates/_birthday_front.html'
                };
            }])
    })();



    (function addProfileCtl() {

        app.factory('NotificationService', ['$http', '$q', '$timeout', 'ErrorService',
            'Notification',
            function ($http, $q, $timeout, ErrorService, Notification) {

                var service = {};



                service.getMyNotifications = function()
                {
                    var result = {
                        _status: 'loading',
                        data: [],
                    };

                    $http({
                        'method': 'GET',
                        'url': '/v3/users/me/notifications',
                        'headers': {
//                            'x-set-timeout': 5000
                        }
                    }).then(function(res) {
                        result._status = 'done';
                        var notifications = [];
                        for (var i in res.data) {
                            notifications.push(new Notification(res.data[i]));
                        }
                        result.data = notifications;
                    });

                    return result;
                };

                service.addTestNotification = function()
                {
                    var notification = new Notification({
                        _status: 'loading',
                    });
                    $http({
                        'method': 'POST',
                        data: {
                            message: 'hello world',
                            created: 'ignored field'
                        },
                        headers: {
                            'X-SET-TIMEOUT': 5000
                        },
                        'url': '/v3/users/me/notifications'
                    }).then(function(res) {
                        notification.setData({_status:'done'});
                        notification.setData(res.data);

                    });

                    return notification;
                };


                return service;

            }]);

        app.factory('Notification', ['$http', '$q', '$timeout', 'ErrorService',
            function ($http, $q, $timeout, ErrorService,) {
                function Model(data) {
                    if (data) {
                        this.setData(data);
                    }
                }

                Model.prototype = {
                    setData: function (data) {
                        angular.extend(this, data);
                    },
                    remove: function () {
                        var self = this;
                        self._status = 'deleted';
                        $http({
                            method: 'DELETE',
                            url: '/v3/users/me/notifications/' + self._id
                        }).then(function (res) {
//                            self._status = '';
//                            new Noty({
//                                text: 'Removed Notification',
//                                type: 'success',
//                                timeout: 1000
//                            }).show();
                        }, ErrorService.handleHttpError);
                    },
                    isDeleted: function() {
                        return this._status == 'deleted';
                    }
                };

                return Model;
            }]);


        app.directive('notification', function () {
            return {
                restrict: 'E',
                scope: {
                    notification: '=notification',
                    devMode: '=devMode'
                },
                templateUrl: 'directives/_notification.html'
            };
        });


        app.controller('profileCtl', ['_user', '$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'hotkeys','ErrorService',
            'NotificationService', 'Notification',
            function (_user, $rootScope, $cookies, $scope, $location, $http, $routeParams,
                      hotkeys, ErrorService,
                      NotificationService,Notification) {
                $scope._user = _user;

                hotkeys.bindTo($scope)
                    .add({
                        combo: 'd e v',
                        description: 'Dev mode',
                        callback: function () {
                            $scope.devMode = !$scope.devMode;
                        }
                    });

                $scope.testTvNotification = function()
                {
                    $http({
                        'method': 'POST',
                        url: '/v1/testsuites/run/tvnotifications'
                    }).then(function(res) {
                        console.log(res.data);
                    },ErrorService.handleHttpError)
                };


                $scope.notificationsRequest = NotificationService.getMyNotifications();


                $scope.addTestNotification = function() {
                    $scope.notificationsRequest.data.push(
                        NotificationService.addTestNotification());
                };


                $scope.addDollar = function() {

                    $http.post('/v1/users/' + $scope._user._id + '/inc', {
                        inc: 1
                    }, {
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(function successCallback(res) {
                            new Noty({
                                text: JSON.stringify(res.data, null, '  '),
                                animation: {}
                            }).show();
                        },
                        function errorCallback(res) {
                            new Noty({
                                text: JSON.stringify(res.data, null, '  '),
                                animation: {}
                            }).show();
                        });
                };
            }])
    })();


    (function addLoginCtl() {
        app.controller('loginCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'UserService', 'hotkeys', 'LoggedInService',
            function ($rootScope, $cookies, $scope, $location, $http,
                      $routeParams, UserService, hotkeys, LoggedInService) {
                $scope.login = function () {
                    UserService.loginForm($scope.formData).then(function () {
                        $location.path('/profile');
                    });
                };
            }]);

        app.controller('signupCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'UserService', 'hotkeys', 'LoggedInService',
            function ($rootScope, $cookies, $scope, $location, $http,
                      $routeParams, UserService, hotkeys, LoggedInService) {
                $scope.formData = {};
                $scope.login = function () {
                    UserService.loginForm($scope.formData).then(function () {
                        $location.path('/profile');
                    });
                };
            }])
    })();

    (function addCommonDirectives() {
        app.directive('loadingIcon', function () {
            return {
                restrict: 'E',
                scope: {
                    obj: '=obj',

                },
                templateUrl: 'templates/_loading-icon.html'
            };
        });
        app.directive("preview", function () {
            function link(scope, element) {
                var iframe = document.createElement('iframe');
                var element0 = element[0];
                element0.appendChild(iframe);
                var body = iframe.contentDocument.body;

                scope.$watch('content', function () {
                    body.innerHTML = scope.content;
                });
            }

            return {
                link: link,
                restrict: 'E',
                scope: {
                    content: '='
                }
            };
        });
    })();

    (function addOtherRouteCtls() {
        //http://www.webdeveasy.com/angularjs-data-model/
        //https://api.github.com/repos/russjohnson09/coderuss/commits/4c20768f288af579519e887674ddcea5300a7d1d
        app.factory('Gitcommit', ['$http', function ($http) {
            function Gitcommit(data) {
                if (data) {
                    this.setData(data);
                }
            };

            const GITHUB_API = '/v1/proxy/github';

            var context = '';
            Gitcommit.prototype = {
                setContext: function (val) {
                    context = val;
                },
                getContext: function () {
                    return context;
                },
                setData: function (data) {
                    angular.extend(this, data);
                },
                getStats: function () {
                    console.log('getStats', this, this.stats);
                    if (typeof this.stats == 'undefined') {
                        this.stats = {};
                        this.populateCommit();
                    }

                    return this.stats;
                },
                updateCommitStatusPending: function () {
                    var self = this;
                    var url = GITHUB_API
                        + '/repos/russjohnson09/coderuss/statuses/' + self.sha;

                    var data = {
                        "state": "pending",
                        "target_url": window.location.origin + self.sha,
                        "description": "pending",
                        "context": self.getContext()
                    };

                    console.log('updateCommitStatusPending', data);

                    $http(
                        {
                            method: 'POST',
                            url: url,
                            data: JSON.stringify(data),
                            headers: {
                                'content-type': 'application/json',
                                'cache-control': 'no-cache'
                            },
                        }
                    ).then(function (response) {
                        console.log('updateCommitStatusPending', response);
                        if (response.data && response.data) {
                            self.setData(response.data);
                        }
                    });
                },
                updateCommitStatusSuccess: function () {
                    var self = this;
                    var url = GITHUB_API
                        + '/repos/russjohnson09/coderuss/statuses/' + self.sha;

                    var data = {
                        "state": "success",
                        "target_url": window.location.origin + self.sha,
                        "description": "success description",
                        "context": self.getContext()
                    };

                    console.log('updateCommitStatusPending', data);

                    $http(
                        {
                            method: 'POST',
                            url: url,
                            data: JSON.stringify(data),
                            headers: {
                                'content-type': 'application/json',
                                'cache-control': 'no-cache'
                            },
                        }
                    ).then(function (response) {
                        console.log('updateCommitStatusPending', response);
                        if (response.data && response.data) {
                            self.setData(response.data);
                        }
                    });
                },
                populateCommit: function () {
                    var self = this;
                    console.log('populateCommit');
                    var url = GITHUB_API
                        + '/repos/russjohnson09/coderuss/commits/' + self.sha;
                    //X-GitHub-Request-Id
                    //xsrfHeaderName
                    console.log('populateCommit', url);

                    $http(
                        {
                            method: 'GET',
                            url: url,
//                        xsrfHeaderName: 'X-GitHub-Request-Id ',
                            headers: {
                                'content-type': 'application/json',
                                'cache-control': 'no-cache'
                            },
//                        params: {
////                            _proxy: 1,
////                            query: $scope.movie.query
//                        }
                        }
                    ).then(function (response) {
                        console.log('populateCommit', response);
                        if (response.data && response.data) {
                            self.setData(response.data);
                        }
                    });
//                /repos/russjohnson09/coderuss/commits/{{sha}}
//                $http.get()
//                    .then(function(data) {
//                        console.log(data);
//                });
                },
                loadCommitData: function (sha) {
                    var scope = this;
                    $http.get('ourserver/books/' + bookId).success(function (bookData) {
                        scope.setData(bookData);
                    });
                },
                load: function (id) {
                    var scope = this;
                    $http.get('ourserver/books/' + bookId).success(function (bookData) {
                        scope.setData(bookData);
                    });
                },
                delete: function () {
                    $http.delete('ourserver/books/' + bookId);
                },
                update: function () {
                    $http.put('ourserver/books/' + bookId, this);
                },
                getImageUrl: function (width, height) {
                    return 'our/image/service/' + this.book.id + '/' + width + '/' + height;
                },
                isAvailable: function () {
                    if (!this.book.stores || this.book.stores.length === 0) {
                        return false;
                    }
                    return this.book.stores.some(function (store) {
                        return store.quantity > 0;
                    });
                }
            };

            return Gitcommit;
        }]);

        app.controller('gitreviewCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'Gitcommit',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, Gitcommit) {

                console.log('gitreviewCtl');

                console.log('cookies', $cookies.getAll());

                //        $scope.sha = $routeParams.sha;

                var gitcommit = $scope.gitcommit = new Gitcommit({sha: $routeParams.sha});

                var url = '/v1/ping';
                $http(
                    {
                        method: 'GET',
                        url: url,
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {
                    console.log(url, response);
                    gitcommit.setContext(response.data.server.context);
                });
            }]);

        app.controller('shewasprettyCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams) {

//            var url = '/v1/ping';
//            $http(
//                {
//                    method: 'GET',
//                    url: url,
//                    headers: {
//                        'content-type': 'application/json',
//                        'cache-control': 'no-cache'
//                    },
//                }
//            ).then(function (response) {
//                console.log(url, response);
//            });

                url = 'http://myasiantv.online/video/drama/she-was-pretty/episode-3/';

                url = '/v1/shewaspretty';
                $http(
                    {
                        method: 'GET',
                        url: url,
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {
                    console.log(url, response);
                    $scope.episodes = response.data;
                }, function (err) {
                    console.error(err);
                });
            }]);

        app.controller('movieCtl', function ($rootScope, $scope, $location, $http, $routeParams) {

            $scope.ID = $routeParams.ID;

            $scope.formData = {};

            $scope.alerts = [];

            $scope.movie = {};

            $scope.movieSearch = {};

            //https://image.tmdb.org/t/p/w500/n1y094tVDFATSzkTnFxoGZ1qNsG.jpg
            $scope.searchMovie = function (movie) {
                console.log('searchMovie');
                $http(
                    {
                        method: 'get',
                        url: '/proxy/themoviedb/search/movie',
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                        params: {
                            _proxy: 1,
                            query: $scope.movie.query
                        }
//                    qs: {
//                        query: $scope.movie.query
//                    }
                    }
                ).then(function (response) {
                    if (response.data && response.data.results &&
                        response.data.results[0]) {
                        Object.assign($scope.movie, response.data.results[0])
                        //https://image.tmdb.org/t/p/w500/n1y094tVDFATSzkTnFxoGZ1qNsG.jpg
                        if ($scope.movie.backdrop_path) {
                            $scope.movie.imagePath = 'https://image.tmdb.org/t/p/w500' + $scope.movie.backdrop_path
                        }
                    }
                    console.log(response);
                }, function (err) {
                    console.log(err);
                })
            };

            var params = $location.search();

        })
            .directive('movie', function () {
                return {
                    restrict: 'E',
                    scope: {
                        movie: '=movie',
                        searchMovie: '=searchMovie'

                    },
                    templateUrl: 'directives/movie.html'
                };
            });


        app.controller('testsCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', '$sce',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, $sce) {

                var APP_BASE_URL = '';

                $scope.testMain = function () {
                    var url = APP_BASE_URL + '/v1/selftest/main/run';
                    $http(
                        {
                            method: 'POST',
                            url: url,
                            headers: {
                                'content-type': 'application/json',
                                'cache-control': 'no-cache'
                            },
                        }
                    ).then(function (response) {

                        var result = [];
                        console.log(response.data);
                        response.data.tests.forEach(function (test) {
                            result.push(test);
                            test.response.rawResponseHtml = $sce.trustAsHtml(test.response.rawResponseBody);

                        });

                        $scope.tests = result;

                    }, function (err) {
                        console.error(err);
                    });
                };

                $scope.testFail = function () {
                    var url = APP_BASE_URL + '/v1/selftest/main/runfail';
                    $http(
                        {
                            method: 'POST',
                            url: url,
                            headers: {
                                'content-type': 'application/json',
                                'cache-control': 'no-cache'
                            },
                        }
                    ).then(function (response) {

                        var result = [];
                        console.log(response.data);
                        response.data.tests.forEach(function (test) {
                            result.push(test);
                            test.response.rawResponseHtml = $sce.trustAsHtml(test.response.rawResponseBody);

                        });

                        $scope.tests = result;

                    }, function (err) {
                        console.error(err);
                    });
                };
            }]);
    })();



</script>

<script src="routes/apitests/apitests.js">

</script>

<script src="routes/users/users.js"></script>
<script src="routes/habits/habits.js"></script>
<script src="routes/fitbit/fitbit.js"></script>


<footer class="footer">
    <!--<kbd><kbd>ctrl</kbd> + <kbd>,</kbd></kbd>-->
</footer>
</body>

</html>

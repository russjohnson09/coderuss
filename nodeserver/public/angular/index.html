<!doctype html>

<!-- ASSIGN OUR ANGULAR MODULE -->
<html>

<head>

    <base href="/angular/">
    <!-- META -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Optimize mobile viewport -->

    <title>Coderuss</title>

    <link rel="stylesheet" href="/css/ext/bootstrap.min.css">
    <style>
    </style>


    <script src="https://use.fontawesome.com/7c2b0d3adf.js"></script>


    <!--<script src="/js/ext/jquery-3.2.1.min.js"></script>-->
    <script src="/bower_components/jquery/dist/jquery.js"></script>

    <script src="/bower_components/angular/angular.min.js"></script>
    <script src="/bower_components/angular-cookies/angular-cookies.min.js"></script>

    <script src="/js/ext/bootstrap-3.3.7.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-route.js"></script>

    <script src="/bower_components/moment/moment.js"></script>
    <script src="/bower_components/moment-timezone/builds/moment-timezone-with-data.js"></script>

    <script src="/bower_components/angular-hotkeys/build/hotkeys.js"></script>
    <link rel="stylesheet" href="/bower_components/angular-hotkeys/build/hotkeys.css">

    <script src="/bower_components/angular-sanitize/angular-sanitize.js"></script>

</head>

<body ng-app="app" ng-cloak>

<nav ng-controller="navbarCtl" class="navbar navbar-default">
    <div class="container-fluid" ng-cloak>
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <!--<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">-->
                <!--<span class="sr-only">Toggle navigation</span>-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
            <!--</button>-->
            <a class="navbar-brand" href="/angular">coderuss</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
            <ul class="nav navbar-nav">
                <!--<li ng-class="{active: isActive('/habits')}"><a href="#!/habits">habits</a></li>-->
            </ul>

            <div ng-show="getCurrentUser().isLoaded()">
                <ul class="nav navbar-nav navbar-right " ng-show="(getCurrentUser().isLoggedIn())">
                    <li class="dropdown">
                        <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button"
                           aria-haspopup="true" aria-expanded="false">{{getCurrentUser().username}} <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="#!/profile">Profile</a></li>
                            <li><a href="#!/habits">Habits</a></li>
                            <li ng-show="getCurrentUser().isAdmin()"><a href="#!/tvshows">TV</a></li>
                            <li ng-show="getCurrentUser().isAdmin()"><a href="#!/users">Users</a></li>
                            <li ng-show="getCurrentUser().isAdmin()"><a href="#!/shewaspretty">She was pretty</a></li>
                            <li ng-show="getCurrentUser().isAdmin()"><a href="#!/hello">Hello</a></li>
                            <li><a href="#!/logout">Logout</a></li>
                        </ul>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right " ng-show="!(getCurrentUser().isLoggedIn())">
                    <li ng-class="{active: isActive('/signin')}"><a href="#!/signin">sign in</a></li>
                    <li ng-class="{active: isActive('/signup')}"><a href="#!/signup">sign up</a></li>
                </ul>
            </div>

    </div><!-- /.container-fluid -->
</nav>


<div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div ng-view></div>
            </div>
        </div>

        <div ng-show="devMode" class="user">
            {{user}}
        </div>

</div>

<script>

    var app = angular.module('app',
        ['ngRoute', 'ngCookies','cfp.hotkeys','ngSanitize']);

    app.config(function ($routeProvider,$locationProvider) {
        console.log('routeProviderConfig', $routeProvider);
        var userResolve = {
            _user: function(User) {
                console.log('resolve profile');
                var UserService = new User();
                console.log(UserService);
                return new Promise(function(resolve) {
                    UserService.getCurrentUser().then(function(user) {
                        console.log(user);
                        resolve(user);
                    });
                })
            }
        };
        $routeProvider
            .when("/login", {
                templateUrl: "templates/login.html",
                controller: "loginCtl"
            })
            .when("/signin", {
                templateUrl: "templates/login.html",
                controller: "loginCtl"
            })
            .when("/signup", {
                templateUrl: "templates/signup.html",
                controller: "signupCtl"
            })
            .when("/logout", {
                controller: "logoutCtl",
                templateUrl: "templates/logout.html"
            })
            .when('/anchors', {
                templateUrl: 'templates/anchors.html'
            })
            .when("/habits", {
                templateUrl: "templates/habits.html",
                controller: "habitsCtl",
                resolve: userResolve,
            })
            .when('/movie', {
                templateUrl: 'templates/movie.html',
                controller: "movieCtl"
            })
            .when('/gitreview/:sha', {
                templateUrl: 'templates/gitreview.html',
                controller: "gitreviewCtl"
            })
            .when("/tests", {
                templateUrl: "templates/tests.html",
                controller: "testsCtl"
            })
            .when("/tvshows", {
                templateUrl: "templates/tvshows/tvshows.html",
                controller: "tvshowsCtl",
                resolve: userResolve,
            })
            .when("/tvshows/search", {
                templateUrl: "templates/tvshows/search-tvshows.html",
                controller: "tvshowsCtl",
                resolve: userResolve,
            })
            .when("/profile", {
                templateUrl: "templates/profile.html",
                controller: "profileCtl",
                resolve: userResolve,
            })
            .when('/shewaspretty', {
                templateUrl: 'templates/shewaspretty.html',
                controller: "shewasprettyCtl"
            })
            .when('/hello', {
                templateUrl: 'templates/hello.html',
                controller: "helloCtl"
            })
            .otherwise({
                redirectTo: '/'
            });
    });

    app.run(function($rootScope,LoggedInService) {
        $rootScope.$on("$routeChangeStart", function(event, next, current) {
            console.log(event,next,current);
        });
        $rootScope.$on("$routeChangeSuccess", function(event, next, current) {
            console.log(event,next,current);
        });
    });

    (function addTvshowRoute() {

        app.factory('TvshowService', ['$http', '$q', function ($http, $q) {

            var service = {};

            var baseurl = 'http://api.tvmaze.com';

            var apibaseurl = '';

            function Tvshow(data) {
                if (data) {
                    this.setData(data);
                }
            };

            Tvshow.prototype = {
                setData: function(data) {
                    angular.extend(this, data);
                },
                addToUserList: function() {
                    console.log('added tv show to list',this);
                }
            };

            service.search = function(searchstring)
            {
                var url = baseurl + '/search/shows';
                return $q(function(resolve,reject) {
                    $http(
                        {
                            method: 'GET',
                            params: {
                                q: searchstring
                            },
                            url: url
                        }).then(
                        function (res) {
                            var tvshows = [];
                            for (var i in res.data) {
                                var tvshow = new Tvshow(res.data[i]);

                                tvshows.push(tvshow);
                            }
                            resolve(tvshows);
                        },
                        function (res) {
                            console.error(res);
                        });
                })

            };

            return service;
        }]);


        app.controller('searchTvshowsCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams','hotkeys','UserService', 'TvshowService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,
                      UserService, TvshowService) {

                hotkeys.bindTo($scope)
                    .add({
                        combo: 'd e v',
                        description: 'Dev mode',
                        callback: function() {
                            $scope.devMode = !$scope.devMode;
                        }
                    });

                $scope.search = function()
                {
                    console.log('tvshowsCtl','search',$scope.searchstring);
                    TvshowService.search($scope.searchstring).then(function(tvshows){
                        $scope.tvshows = tvshows;

                    });
                }
            }])


        app.controller('tvshowsCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams','hotkeys','UserService', 'TvshowService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,
                      UserService, TvshowService) {

                hotkeys.bindTo($scope)
                    .add({
                        combo: 'd e v',
                        description: 'Dev mode',
                        callback: function() {
                            $scope.devMode = !$scope.devMode;
                        }
                    });

                $scope.search = function()
                {
                    console.log('tvshowsCtl','search',$scope.searchstring);
                    TvshowService.search($scope.searchstring).then(function(tvshows){
                        $scope.tvshows = tvshows;

                    });
                }
            }])
    })();

    (function addLogoutCtl() {
        app.controller('logoutCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams','hotkeys','UserService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,UserService) {
                $scope.isActive = function(path) {
                    return path === $location.path();
                };

                UserService.logout().then(function(data) {
                    console.log(data);
                    $location.path('/signin');
                });
            }])
    })();

    (function addNavbarCtl() {

        app.controller('navbarCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams','hotkeys','UserService',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys,UserService) {
                $scope.isActive = function(path) {
                    return path === $location.path();
                };

                $scope.getCurrentUser = UserService.getCurrentUser;

//                UserService.getCurrentUser().then(function(user) {
//                    console.log('navbarCtl',user);
//                    $scope._user = user;
//                }, function(err) {
//                    console.log(e);
//                });
            }])
    })();


    (function addHelloCtl() {
        app.controller('helloCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams','hotkeys',
            function ($rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys) {
                $scope.hello = {};
            }])
    })();

    app.factory('LoggedInService', ['$http', '$q', function ($http, $q) {

        var loggedInUser = null;

        var service ={
            setLoggedInUser: function(u) {
                loggedInUser = u;
                console.log(loggedInUser)
            },
            getLoggedInUser: function() {
                return loggedInUser;
            },
        };

        return service;

    }]);

    app.factory('UserService', ['$http', '$q', function ($http, $q) {

        var service = {};

        var baseurl = '';

        function User(data) {
            if (data) {
                this.setData(data);
            }
        };

        User.prototype.setData = function(data) {
            angular.extend(this, data);
        };

        User.prototype.isAdmin = function()
        {
            return this.is_admin === 1;
        };

        User.prototype.getLevel = function()
        {
            if (this._id == 'anon') {
                return 'anon';
            }
            else {
                return 'consumer';
            }
        };

        User.prototype.isLoaded = function()
        {
            return this._id;
        };

        User.prototype.isLoggedIn = function() {
            return this.getLevel() !== 'anon';
        };

        service.loginForm = function(formData)
        {
            return $q(function(resolve,reject) {
                $http.post('/v1/login', formData).then(
                    function (res) {
                        if (res.status === 201) {
                            return service.populateCurrentUser().then(resolve);
                        }
                    },
                    function (res) {
                        console.log(res.status);
                    });
            })

        };

        service.logout = function() {
            return $q(function(resolve,reject) {
                $http({
                    'method': 'POST',
                    'url': '/v1/logout'
                }).then(function(response) {
                        service.setCurrentUserToAnon();
                        resolve(response.data);
                    },
                    reject
                )
            });
        };

        service.setCurrentUserToAnon = function()
        {
            service._user = service.getAnonUser();
        };

        service.getAnonUser = function()
        {
            return new User({_id: 'anon'});
        };


        service.populateCurrentUser = function() {
            if (service._user == undefined) {
                service._user = new User({});
            }
            var url = baseurl + '/v1/users/me';

            return $q(function(resolve) {
                $http(
                    {
                        method: 'GET',
                        url: url,
                        headers: {},
                    }
                ).then(function (response) {
                    service._user = new User(response.data);
                    resolve(service._user);
                }, function() {
                    console.log('populateCurrentUser');
                    service.setCurrentUserToAnon();
                    resolve(service._user);
                });
            })
        };

        service.getCurrentUser = function () {
            if (service._user == undefined) {
                service.populateCurrentUser();
            }
            return service._user;

        };

        return service;
    }]);

        app.factory('User', ['$http', '$q', function ($http, $q) {
        function User(data) {
            if (data) {
                this.setData(data);
            }
        };

        var baseurl = '';


        User.prototype = {

            setData: function (data) {
                angular.extend(this,{dates: {}}, data);
            },
            getCurrentUser: function () {
                var self = this;
                return $q(function(resolve) {
                    var url = baseurl + '/v1/users/me';
                    $http(
                        {
                            method: 'GET',
                            url: url,
                            headers: {},
                        }
                    ).then(function (response) {
                        var user = new User(response.data);
                        resolve(user);
                    });
                });

            }
        };

        return User;
    }]);


    (function addProfileCtl() {
        app.controller('profileCtl', ['_user','$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams','hotkeys',
            function (_user,$rootScope, $cookies, $scope, $location, $http, $routeParams, hotkeys) {
                $scope._user = _user;
                console.log($scope._user);
            }])
    })();


    (function addLoginCtl() {
        app.controller('loginCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'UserService','hotkeys','LoggedInService',
            function ($rootScope, $cookies, $scope, $location, $http,
                      $routeParams, UserService, hotkeys,LoggedInService) {
                $scope.login = function()
                {
                    UserService.loginForm($scope.formData).then(function() {
                        $location.path('/profile');
                    });
                };
            }]);

        app.controller('signupCtl', ['$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'UserService','hotkeys','LoggedInService',
            function ($rootScope, $cookies, $scope, $location, $http,
                      $routeParams, UserService, hotkeys,LoggedInService) {
                $scope.formData = {};
                $scope.login = function()
                {
                    UserService.loginForm($scope.formData).then(function() {
                        $location.path('/profile');
                    });
                };
            }])
    })();

    (function addHabitsCtl() {
        app.factory('Habit', ['$http', '$q', function ($http, $q) {
            function Habit(data) {
                if (data) {
                    this.setData(data);
                }
            };

            var baseurl = '';

            Habit.prototype = {
                setData: function (data) {
                    angular.extend(this,{dates: {}}, data);
                },
                getJSON: function () {
                    return JSON.stringify(this.getJSONObject());
                },
                getJSONObject: function () {
                    return {
                        text: this.text,
                    }
                },
                getHabits: function () {
                    console.log('get habits')
                    var self = this;
                    var url = baseurl + '/v1/habits';
                    return $q(function (resolve, reject) {
                        $http(
                            {
                                method: 'GET',
                                url: url,
                                headers: {
                                    'cache-control': 'no-cache'
                                },
                            }
                        ).then(function (response) {
                            var habits = [];
                            if (response.data) {
                                for (var i in response.data) {
                                    habits.push(new Habit(response.data[i]));
                                }
                                resolve(habits);
                            }
                        });
                    })
                },
                add: function () {
                    var self = this;
                    return $q(function(resolve) {
                        var url = baseurl + '/v1/habits';
                        $http(
                            {
                                method: 'POST',
                                url: url,
                                data: self.getJSON(),
                                headers: {
                                    'content-type': 'application/json',
                                    'cache-control': 'no-cache'
                                },
                            }
                        ).then(function (response) {
                            if (response.data && response.data) {
                                self.setData(response.data);
                                resolve(self);
                            }
                        });
                    });

                },
                getStatus: function () {
                    return this._status;
                },
                updateDate: function(date)
                {
                    var self = this;
                    var status;
                    if (self.getDate(date).status !== 'complete') {
                        status = 'complete';
                    }
                    else {
                        status = 'incomplete';
                    }
                    var url = baseurl + '/v1/habits/' + self._id + '/dates/' + date;
                    $http(
                        {
                            method: 'POST',
                            url: url,
                            headers: {},
                            data: {
                                status: status
                            }
                        }
                    ).then(function (response) {
                        self.dates[date] = response.data;
                    });
                },
                populateDate: function (date) {
                    var self = this;
                    var url = baseurl + '/v1/habits/' + self._id + '/dates/'
                        + date;
                    $http(
                        {
                            method: 'GET',
                            url: url,
                            headers: {},
                        }
                    ).then(function (response) {
                        self.dates[date] = response.data;
                    });
                },
                getDate: function (date) {
                    var self = this;

                    if (self.dates[date] === undefined) {
                        self.dates[date] = 'loading';
                        self.populateDate(date);
                    }

                    return self.dates[date];
                },
                delete: function () {
                    var self = this;
                    this._status = 'deleted';
                    var url = baseurl + '/v1/habits/' + self._id;
                    $http(
                        {
                            method: 'DELETE',
                            url: url,
                            headers: {
                                'content-type': 'application/json',
                                'cache-control': 'no-cache'
                            },
                        }
                    ).then(function (response) {
                    });
                }
            };

            return Habit;
        }]);

        app.controller('habitsCtl', ['_user','$rootScope', '$cookies', '$scope', '$location',
            '$http', '$routeParams', 'Habit','hotkeys','User',
            function (_user,$rootScope, $cookies, $scope, $location, $http, $routeParams, Habit,
            hotkeys,
            User) {
                $scope._user = _user;
                console.log($scope._user);
                var HabitService = new Habit();
                var UserService = new User();

                UserService.getCurrentUser().then(function(user) {
                    $rootScope.user = user;
                });

                $scope.habits = [
//                    new Habit({
//                        'id': 1,
//                        'description': 'exercise',
//                    })
                ];
                $scope.devMode = false;

                hotkeys.bindTo($scope)
                    .add({
                        combo: 'd e v',
                        description: 'Dev mode',
                        callback: function() {
                            $scope.devMode = !$scope.devMode;
                        }
                    });
                    // you can chain these methods for ease of use:
//                    .add ({...});


                //https://momentjs.com/docs/#/displaying/
                $scope.weekdays = [];
                var startOfWeek = moment().startOf('week');
                for(var i = 0;i < 7; i++) {
                    $scope.weekdays.push(moment(startOfWeek).add(i,'days'));
                }

                HabitService.getHabits().then(function (habits) {
                    $scope.habits = habits;
                });


                $scope.newhabit = new Habit({});

                $scope.addHabit = function () {
                    $scope.newhabit.add().then(function(habit) {
                        $scope.habits.push(habit);
                    });
                    $scope.newhabit = new Habit({});
                };

                console.log($scope.habits);


            }]);


    })();


    app.directive("preview", function () {
        function link(scope, element) {
            var iframe = document.createElement('iframe');
            var element0 = element[0];
            element0.appendChild(iframe);
            var body = iframe.contentDocument.body;

            scope.$watch('content', function () {
                body.innerHTML = scope.content;
            });
        }

        return {
            link: link,
            restrict: 'E',
            scope: {
                content: '='
            }
        };
    });


    //http://www.webdeveasy.com/angularjs-data-model/
    //https://api.github.com/repos/russjohnson09/coderuss/commits/4c20768f288af579519e887674ddcea5300a7d1d
    app.factory('Gitcommit', ['$http', function ($http) {
        function Gitcommit(data) {
            if (data) {
                this.setData(data);
            }
        };

        const GITHUB_API = '/v1/proxy/github';

        var context = '';
        Gitcommit.prototype = {
            setContext: function (val) {
                context = val;
            },
            getContext: function () {
                return context;
            },
            setData: function (data) {
                angular.extend(this, data);
            },
            getStats: function () {
                console.log('getStats', this, this.stats);
                if (typeof this.stats == 'undefined') {
                    this.stats = {};
                    this.populateCommit();
                }

                return this.stats;
            },
            updateCommitStatusPending: function () {
                var self = this;
                var url = GITHUB_API
                    + '/repos/russjohnson09/coderuss/statuses/' + self.sha;

                var data = {
                    "state": "pending",
                    "target_url": window.location.origin + self.sha,
                    "description": "pending",
                    "context": self.getContext()
                };

                console.log('updateCommitStatusPending', data);

                $http(
                    {
                        method: 'POST',
                        url: url,
                        data: JSON.stringify(data),
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {
                    console.log('updateCommitStatusPending', response);
                    if (response.data && response.data) {
                        self.setData(response.data);
                    }
                });
            },
            updateCommitStatusSuccess: function () {
                var self = this;
                var url = GITHUB_API
                    + '/repos/russjohnson09/coderuss/statuses/' + self.sha;

                var data = {
                    "state": "success",
                    "target_url": window.location.origin + self.sha,
                    "description": "success description",
                    "context": self.getContext()
                };

                console.log('updateCommitStatusPending', data);

                $http(
                    {
                        method: 'POST',
                        url: url,
                        data: JSON.stringify(data),
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {
                    console.log('updateCommitStatusPending', response);
                    if (response.data && response.data) {
                        self.setData(response.data);
                    }
                });
            },
            populateCommit: function () {
                var self = this;
                console.log('populateCommit');
                var url = GITHUB_API
                    + '/repos/russjohnson09/coderuss/commits/' + self.sha;
                //X-GitHub-Request-Id
                //xsrfHeaderName
                console.log('populateCommit', url);

                $http(
                    {
                        method: 'GET',
                        url: url,
//                        xsrfHeaderName: 'X-GitHub-Request-Id ',
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
//                        params: {
////                            _proxy: 1,
////                            query: $scope.movie.query
//                        }
                    }
                ).then(function (response) {
                    console.log('populateCommit', response);
                    if (response.data && response.data) {
                        self.setData(response.data);
                    }
                });
//                /repos/russjohnson09/coderuss/commits/{{sha}}
//                $http.get()
//                    .then(function(data) {
//                        console.log(data);
//                });
            },
            loadCommitData: function (sha) {
                var scope = this;
                $http.get('ourserver/books/' + bookId).success(function (bookData) {
                    scope.setData(bookData);
                });
            },
            load: function (id) {
                var scope = this;
                $http.get('ourserver/books/' + bookId).success(function (bookData) {
                    scope.setData(bookData);
                });
            },
            delete: function () {
                $http.delete('ourserver/books/' + bookId);
            },
            update: function () {
                $http.put('ourserver/books/' + bookId, this);
            },
            getImageUrl: function (width, height) {
                return 'our/image/service/' + this.book.id + '/' + width + '/' + height;
            },
            isAvailable: function () {
                if (!this.book.stores || this.book.stores.length === 0) {
                    return false;
                }
                return this.book.stores.some(function (store) {
                    return store.quantity > 0;
                });
            }
        };

        return Gitcommit;
    }]);

    app.controller('gitreviewCtl', ['$rootScope', '$cookies', '$scope', '$location',
        '$http', '$routeParams', 'Gitcommit',
        function ($rootScope, $cookies, $scope, $location, $http, $routeParams, Gitcommit) {

            console.log('gitreviewCtl');

            console.log('cookies', $cookies.getAll());

            //        $scope.sha = $routeParams.sha;

            var gitcommit = $scope.gitcommit = new Gitcommit({sha: $routeParams.sha});

            var url = '/v1/ping';
            $http(
                {
                    method: 'GET',
                    url: url,
                    headers: {
                        'content-type': 'application/json',
                        'cache-control': 'no-cache'
                    },
                }
            ).then(function (response) {
                console.log(url, response);
                gitcommit.setContext(response.data.server.context);
            });
        }]);

    app.controller('shewasprettyCtl', ['$rootScope', '$cookies', '$scope', '$location',
        '$http', '$routeParams',
        function ($rootScope, $cookies, $scope, $location, $http, $routeParams) {

//            var url = '/v1/ping';
//            $http(
//                {
//                    method: 'GET',
//                    url: url,
//                    headers: {
//                        'content-type': 'application/json',
//                        'cache-control': 'no-cache'
//                    },
//                }
//            ).then(function (response) {
//                console.log(url, response);
//            });

            url = 'http://myasiantv.online/video/drama/she-was-pretty/episode-3/';

            url = '/v1/shewaspretty';
            $http(
                {
                    method: 'GET',
                    url: url,
                    headers: {
                        'content-type': 'application/json',
                        'cache-control': 'no-cache'
                    },
                }
            ).then(function (response) {
                console.log(url, response);
                $scope.episodes = response.data;
            }, function (err) {
                console.error(err);
            });
        }]);

    app.controller('movieCtl', function ($rootScope, $scope, $location, $http, $routeParams) {

        $scope.ID = $routeParams.ID;

        $scope.formData = {};

        $scope.alerts = [];

        $scope.movie = {};

        $scope.movieSearch = {};

        //https://image.tmdb.org/t/p/w500/n1y094tVDFATSzkTnFxoGZ1qNsG.jpg
        $scope.searchMovie = function (movie) {
            console.log('searchMovie');
            $http(
                {
                    method: 'get',
                    url: '/proxy/themoviedb/search/movie',
                    headers: {
                        'content-type': 'application/json',
                        'cache-control': 'no-cache'
                    },
                    params: {
                        _proxy: 1,
                        query: $scope.movie.query
                    }
//                    qs: {
//                        query: $scope.movie.query
//                    }
                }
            ).then(function (response) {
                if (response.data && response.data.results &&
                    response.data.results[0]) {
                    Object.assign($scope.movie, response.data.results[0])
                    //https://image.tmdb.org/t/p/w500/n1y094tVDFATSzkTnFxoGZ1qNsG.jpg
                    if ($scope.movie.backdrop_path) {
                        $scope.movie.imagePath = 'https://image.tmdb.org/t/p/w500' + $scope.movie.backdrop_path
                    }
                }
                console.log(response);
            }, function (err) {
                console.log(err);
            })
        };

        var params = $location.search();

    })
        .directive('movie', function () {
            return {
                restrict: 'E',
                scope: {
                    movie: '=movie',
                    searchMovie: '=searchMovie'

                },
                templateUrl: 'directives/movie.html'
            };
        });


    app.controller('testsCtl', ['$rootScope', '$cookies', '$scope', '$location',
        '$http', '$routeParams', '$sce',
        function ($rootScope, $cookies, $scope, $location, $http, $routeParams, $sce) {

            var APP_BASE_URL = '';

            $scope.testMain = function () {
                var url = APP_BASE_URL + '/v1/selftest/main/run';
                $http(
                    {
                        method: 'POST',
                        url: url,
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {

                    var result = [];
                    console.log(response.data);
                    response.data.tests.forEach(function (test) {
                        result.push(test);
                        test.response.rawResponseHtml = $sce.trustAsHtml(test.response.rawResponseBody);

                    });

                    $scope.tests = result;

                }, function (err) {
                    console.error(err);
                });
            };

            $scope.testFail = function () {
                var url = APP_BASE_URL + '/v1/selftest/main/runfail';
                $http(
                    {
                        method: 'POST',
                        url: url,
                        headers: {
                            'content-type': 'application/json',
                            'cache-control': 'no-cache'
                        },
                    }
                ).then(function (response) {

                    var result = [];
                    console.log(response.data);
                    response.data.tests.forEach(function (test) {
                        result.push(test);
                        test.response.rawResponseHtml = $sce.trustAsHtml(test.response.rawResponseBody);

                    });

                    $scope.tests = result;

                }, function (err) {
                    console.error(err);
                });
            };
        }]);


</script>
</body>

</html>
